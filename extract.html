<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestionnaire de vid√©os JSON - IMSSA 68</title>
<style>
body { 
    font-family: 'Segoe UI', Tahoma, sans-serif; 
    margin: 20px; 
    background-image: url("img/BG.svg"); 
    color: #333; 
    font-size: 16px; 
    line-height: 1.4;
}

h2 { 
    color: #0C5073; 
    margin-bottom: 25px; 
    text-align: center;
}

.controls-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.branch-creator {
    display: grid;
    grid-template-columns: 1fr 1fr auto auto;
    gap: 15px;
    align-items: end;
    margin-bottom: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 5px;
    font-weight: 600;
    color: #555;
}

input, select, textarea { 
    padding: 10px; 
    border-radius: 6px; 
    border: 1px solid #ddd; 
    font-size: 14px;
    font-family: inherit;
    box-sizing: border-box;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #1AA9BE;
    box-shadow: 0 0 0 2px rgba(26, 169, 190, 0.2);
}

button { 
    padding: 10px 20px; 
    border-radius: 6px; 
    border: none; 
    background-color: #1AA9BE; 
    color: white; 
    cursor: pointer; 
    font-size: 14px; 
    font-weight: 600;
    transition: all 0.3s;
    white-space: nowrap;
}

button:hover { 
    background-color: #0C5073; 
    transform: translateY(-1px);
}

.btn-success {
    background-color: #28a745;
}

.btn-success:hover {
    background-color: #218838;
}

#ajouterBtn {
    background-color: #28a745;
}

#ajouterBtn:hover {
    background-color: #218838;
}

.btn-download {
    background-color: #6c757d;
}

.btn-download:hover {
    background-color: #545b62;
}

.cards-container {
    display: grid;
    gap: 20px;
}

.card { 
    background: #fff; 
    padding: 20px; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    transition: all 0.3s;
    position: relative;
    border: 1px solid #eee;
}

.card.loaded {
    background: #f8f4ff;
    border-left: 4px solid #6f42c1;
}

.card.loaded .card-title::after {
    content: " üì•";
    font-size: 12px;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    color: #0C5073;
}

.card-form {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.card input, .card select { 
    width: 100%;
    margin: 0;
}

.preview {
    margin-top: 15px;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
}

.preview iframe { 
    width: 100%; 
    height: 200px; 
    border: none;
}

.preview.empty {
    font-style: italic;
    border: 2px dashed #ddd;
}

.supprimer { 
    background-color: #e74c3c; 
    padding: 8px 12px;
    font-size: 12px;
}

.supprimer:hover { 
    background-color: #c0392b; 
}

.json-section {
    margin-top: 30px;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
}

.json-section h3 {
    color: #0C5073;
    margin-top: 0;
}

.json-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 15px;
}

.btn-load {
    background-color: #6f42c1;
}

.btn-load:hover {
    background-color: #5a32a3;
}

textarea { 
    width: 100%; 
    font-family: 'Consolas', 'Monaco', monospace; 
    font-size: 12px; 
    border-radius: 8px; 
    resize: vertical;
    background: #fff;
}

/* Message de statut fixe en haut */
.status-message {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    opacity: 0;
    transition: all 0.3s ease;
    max-width: 90%;
    text-align: center;
}

.status-message.show {
    opacity: 1;
    animation: slideDown 0.3s ease;
}

.status-message.hide {
    animation: slideUp 0.3s ease;
}

@keyframes slideDown {
    from {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

@keyframes slideUp {
    from {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
    to {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
    }
}

.status-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #666;
}

@media (max-width: 768px) {
    .branch-creator {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .json-controls {
        flex-direction: column;
    }
    
    body {
        margin: 10px;
        font-size: 14px;
    }
}

/* Modal pour la s√©lection des cat√©gories */
.modal {
    display: none;
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background-color: #fff;
    margin: 10% auto;
    padding: 20px;
    border-radius: 12px;
    width: 80%;
    max-width: 500px;
    max-height: 70%;
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        opacity: 0;
        transform: translateY(-50px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

.modal h3 {
    color: #0C5073;
    margin-top: 0;
    margin-bottom: 20px;
}

.category-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 20px;
}

.category-item {
    display: flex;
    align-items: center;
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 5px;
    transition: background-color 0.2s;
}

.category-item:hover {
    background-color: #f8f9fa;
}

.category-item input[type="checkbox"] {
    margin-right: 10px;
    transform: scale(1.2);
}

.category-item label {
    margin: 0;
    cursor: pointer;
    flex-grow: 1;
    font-weight: normal;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-cancel {
    background-color: #6c757d;
}

.btn-cancel:hover {
    background-color: #545b62;
}
</style>
</head>
<body>
<h2>Gestionnaire de vid√©os JSON - IMSSA 68</h2>

<div class="controls-section">
    <div class="branch-creator">
        <div class="form-group">
            <label for="parentPath">Chemin parent existant :</label>
            <select id="parentPath">
                <option value="">Racine</option>
            </select>
        </div>
        <div class="form-group">
            <label for="newBranchName">Nouveau nom de branche :</label>
            <input type="text" id="newBranchName" placeholder="Ex: Nouvelle cat√©gorie">
        </div>
        <button onclick="ajouterBranche()" class="btn-success">+ Cr√©er branche</button>
        <button onclick="supprimerBranche()" style="background-color: #dc3545;">üóëÔ∏è Supprimer branche</button>
    </div>
</div>

<div id="loadingMessage" class="loading">Chargement des donn√©es...</div>
<div id="cardsContainer" class="cards-container" style="display: none;"></div>

<div class="json-section">
    <div class="json-controls">
        <button id="ajouterBtn">+ Ajouter une vid√©o </button>
        <button onclick="genererJSON()">üîÑ G√©n√©rer JSON et copier</button>
        <button onclick="telechargerJSON()" class="btn-download">‚¨áÔ∏è T√©l√©charger JSON</button>
        <button onclick="ouvrirModalChargement()" class="btn-load">üì• Charger vid√©os existantes</button>
    </div>
    <div id="statusMessage" class="status-message"></div>
    
    <h3>Aper√ßu du JSON g√©n√©r√© :</h3>
    <textarea id="resultJSON" rows="15" readonly placeholder="Le JSON g√©n√©r√© appara√Ætra ici..."></textarea>
</div>

<!-- Modal pour la s√©lection des cat√©gories -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <h3>S√©lectionner les cat√©gories √† charger</h3>
        <div class="category-list" id="categoryList">
            <!-- Les cat√©gories seront ajout√©es ici dynamiquement -->
        </div>
        <div class="modal-buttons">
            <button onclick="fermerModalChargement()" class="btn-cancel">Annuler</button>
            <button onclick="chargerVideosSelectionnees()" class="btn-success">Charger les vid√©os</button>
        </div>
    </div>
</div>

<script>
window.addEventListener("beforeunload", function (e) {
    // Message personnalis√© (affichage d√©pend du navigateur)
    e.preventDefault();
    e.returnValue = "Voulez-vous vraiment quitter cette page ? Vos modifications pourraient √™tre perdues.";
});
</script>

<script>
let jsonData = {}; 
let isDataLoaded = false;
let videosOriginalesChargees = new Set(); // Tracker des vid√©os charg√©es √† l'origine

// Chargement des donn√©es JSON
async function chargerDonnees() {
    try {
        const response = await fetch('videos.json');
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        jsonData = await response.json();
        isDataLoaded = true;
        
        // Mise √† jour de l'interface
        mettreAJourChemins();
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('cardsContainer').style.display = 'block';
        
        afficherMessage("Donn√©es charg√©es avec succ√®s !", "success");
    } catch (error) {
        console.error("Erreur lors du chargement des donn√©es :", error);
        
        // Initialiser avec des donn√©es vides si le fichier n'existe pas
        jsonData = {};
        isDataLoaded = true;
        
        mettreAJourChemins();
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('cardsContainer').style.display = 'block';
        
        afficherMessage("Aucun fichier JSON trouv√©. D√©marrage avec des donn√©es vides.", "error");
    }
}

// Mise √† jour de la liste des chemins disponibles
function mettreAJourChemins() {
    const select = document.getElementById('parentPath');
    select.innerHTML = '<option value="">Racine</option>';
    
    function ajouterChemins(obj, chemin = '') {
        Object.keys(obj).forEach(key => {
            const nouveauChemin = chemin ? `${chemin} > ${key}` : key;
            select.innerHTML += `<option value="${nouveauChemin}">${nouveauChemin}</option>`;
            
            if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                ajouterChemins(obj[key], nouveauChemin);
            }
        });
    }
    
    ajouterChemins(jsonData);
}

// V√©rification de la profondeur d'un chemin pour limiter √† 2 niveaux max
function estProfondeurMax(chemin) {
    if (!chemin) return false; // Racine = profondeur 0, autoris√©e
    
    const pathParts = chemin.split(' > ');
    return pathParts.length >= 2; // Profondeur 2 = maximum (Partie > Sous-partie)
}

// Cr√©ation d'une nouvelle branche
function ajouterBranche() {
    const parentPath = document.getElementById('parentPath').value;
    const newBranchName = document.getElementById('newBranchName').value.trim();
    
    if (!newBranchName) {
        afficherMessage("Veuillez saisir un nom pour la nouvelle branche.", "error");
        return;
    }
    
    // V√©rifier si on d√©passe la profondeur maximale (2 niveaux)
    if (estProfondeurMax(parentPath)) {
        afficherMessage("Impossible de cr√©er une sous-branche √† ce niveau. Structure limit√©e √† : Partie > Sous-partie.", "error");
        return;
    }
    
    // Navigation vers l'objet parent
    let current = jsonData;
    if (parentPath) {
        const pathParts = parentPath.split(' > ');
        for (const part of pathParts) {
            if (!current[part]) current[part] = {};
            current = current[part];
        }
    }
    
    // Cr√©ation de la nouvelle branche
    if (!current[newBranchName]) {
        // Si on est √† la racine, cr√©er un objet (partie principale)
        // Si on est au niveau 1, cr√©er un tableau pour les vid√©os (sous-partie)
        if (!parentPath) {
            current[newBranchName] = {};
        } else {
            current[newBranchName] = [];
        }
        
        mettreAJourChemins();
        mettreAJourSelectsCategories(); // Mettre √† jour les selects existants
        document.getElementById('newBranchName').value = '';
        afficherMessage(`Branche "${newBranchName}" cr√©√©e avec succ√®s !`, "success");
    } else {
        afficherMessage(`La branche "${newBranchName}" existe d√©j√†.`, "error");
    }
}

// Suppression d'une branche
function supprimerBranche() {
    const parentPath = document.getElementById('parentPath').value;
    
    if (!parentPath) {
        afficherMessage("S√©lectionnez une branche √† supprimer.", "error");
        return;
    }
    
    if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la branche "${parentPath}" et tout son contenu ?`)) {
        return;
    }
    
    const pathParts = parentPath.split(' > ');
    const brancheName = pathParts.pop();
    
    // Navigation vers l'objet parent
    let current = jsonData;
    for (const part of pathParts) {
        current = current[part];
    }
    
    // Suppression de la branche
    delete current[brancheName];
    
    mettreAJourChemins();
    mettreAJourSelectsCategories();
    document.getElementById('parentPath').value = '';
    afficherMessage(`Branche "${parentPath}" supprim√©e avec succ√®s !`, "success");
}

// Mise √† jour des selects de cat√©gories existants
function mettreAJourSelectsCategories() {
    const categories = genererOptionsCategories();
    document.querySelectorAll('.categorie').forEach(select => {
        const selectedValue = select.value;
        select.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        
        // R√©tablir la s√©lection si elle existe encore
        if (categories.includes(selectedValue)) {
            select.value = selectedValue;
        }
    });
}

// Nouvelle fonction pour afficher les messages avec animation
function afficherMessage(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    
    // Nettoyer les anciennes animations
    statusDiv.classList.remove('show', 'hide');
    statusDiv.className = `status-message status-${type}`;
    statusDiv.textContent = message;
    
    // Forcer le reflow avant d'ajouter la classe show
    statusDiv.offsetHeight;
    statusDiv.classList.add('show');
    
    setTimeout(() => {
        statusDiv.classList.remove('show');
        statusDiv.classList.add('hide');
        
        setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = 'status-message';
        }, 300);
    }, 4000);
}

// G√©n√©ration des options de cat√©gories
function genererOptionsCategories() {
    const options = [];
    
    function parcourir(obj, chemin = '') {
        Object.keys(obj).forEach(key => {
            const nouveauChemin = chemin ? `${chemin} > ${key}` : key;
            
            if (Array.isArray(obj[key])) {
                // Si c'est un tableau, c'est une cat√©gorie finale (sous-cat√©gorie)
                options.push(nouveauChemin);
            } else if (typeof obj[key] === 'object') {
                // Si c'est un objet, continuer √† parcourir mais ne pas l'ajouter comme option
                parcourir(obj[key], nouveauChemin);
            }
        });
    }
    
    parcourir(jsonData);
    return [...new Set(options)]; // Supprimer les doublons
}

// Ajout d'une carte vid√©o
function ajouterCard() {
    if (!isDataLoaded) {
        afficherMessage("Veuillez attendre le chargement des donn√©es.", "error");
        return;
    }
    
    const container = document.getElementById('cardsContainer');
    const categories = genererOptionsCategories();
    
    if (categories.length === 0) {
        afficherMessage("Aucune cat√©gorie disponible. Cr√©ez d'abord une branche.", "error");
        return;
    }
    
    const cardId = 'card_' + Date.now();
    
    const div = document.createElement('div');
    div.className = 'card';
    div.id = cardId;
    div.innerHTML = `
        <div class="card-header">
            <div class="card-title">Nouvelle vid√©o</div>
            <button class="supprimer" onclick="supprimerCard('${cardId}')">üóëÔ∏è Supprimer</button>
        </div>
        <div class="card-form">
            <input type="text" placeholder="Titre de la vid√©o" class="titre" onchange="updateCardTitle('${cardId}')">
            <div class="form-row">
                <input type="text" placeholder="Collez n'importe quel lien YouTube ici" class="iframe" oninput="updatePreview('${cardId}')">
                <select class="categorie">
                    ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                </select>
            </div>
            <div class="preview empty">
                Aucun aper√ßu disponible - Collez un lien YouTube
            </div>
        </div>
    `;
    
    container.appendChild(div);
    
    // Focus sur le champ titre
    div.querySelector('.titre').focus();
}

// Mise √† jour du titre de la carte
function updateCardTitle(cardId) {
    const card = document.getElementById(cardId);
    const titre = card.querySelector('.titre').value;
    const titleElement = card.querySelector('.card-title');
    
    if (titre.trim()) {
        titleElement.textContent = titre;
    } else {
        titleElement.textContent = 'Nouvelle vid√©o';
    }
}

// Extraction de l'ID YouTube depuis n'importe quel type de lien
function extractYouTubeId(url) {
    try {
        const parsedUrl = new URL(url);
        // Cas 1 : youtube.com/watch?v=...
        if (parsedUrl.hostname.includes("youtube.com")) {
            if (parsedUrl.searchParams.has("v")) {
                return parsedUrl.searchParams.get("v");
            }
            // Cas 2 : shorts
            if (parsedUrl.pathname.startsWith("/shorts/")) {
                return parsedUrl.pathname.split("/")[2];
            }
            // Cas 3 : embed d√©j√† en place
            if (parsedUrl.pathname.startsWith("/embed/")) {
                return parsedUrl.pathname.split("/")[2];
            }
        }
        // Cas 4 : youtu.be/ID
        if (parsedUrl.hostname === "youtu.be") {
            return parsedUrl.pathname.substring(1); // enl√®ve le "/"
        }
    } catch (e) {
        console.error("URL invalide :", url);
    }
    return null;
}

// Conversion vers URL embed
function toEmbedUrl(url) {
    const videoId = extractYouTubeId(url);
    if (videoId) {
        return "https://www.youtube-nocookie.com/embed/" + videoId;
    }
    return null;
}

// R√©cup√©ration du titre r√©el de la vid√©o YouTube
async function obtenirTitreYouTube(videoId) {
    try {
        // Essayer d'extraire le titre depuis l'API oEmbed de YouTube
        const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
        if (response.ok) {
            const data = await response.json();
            return data.title;
        }
    } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration du titre YouTube:', error);
    }
    
    // Fallback: utiliser l'ID nettoy√© comme avant
    return decodeURIComponent(videoId).replace(/[-_]/g, ' ');
}

// Mise √† jour de l'aper√ßu vid√©o
function updatePreview(cardId) {
    const card = document.getElementById(cardId);
    const input = card.querySelector('.iframe');
    const previewDiv = card.querySelector('.preview');
    const inputValue = input.value.trim();
    
    if (!inputValue) {
        previewDiv.className = 'preview empty';
        previewDiv.innerHTML = 'Aucun aper√ßu disponible - Collez un lien YouTube ici';
        return;
    }
    
    // Essayer d'extraire l'URL embed
    let embedUrl = null;
    
    // Si c'est d√©j√† un iframe, extraire l'URL src
    const iframeSrcMatch = inputValue.match(/src="([^"]+)"/);
    if (iframeSrcMatch) {
        embedUrl = iframeSrcMatch[1];
    } else {
        // Sinon, traiter comme un lien YouTube normal
        embedUrl = toEmbedUrl(inputValue);
    }
    
    if (embedUrl) {
        previewDiv.className = 'preview';
        previewDiv.innerHTML = `<iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
        
        // Stocker l'URL embed pour la g√©n√©ration JSON
        input.dataset.embedUrl = embedUrl;
    } else {
        previewDiv.className = 'preview empty';
        previewDiv.innerHTML = 'URL YouTube non reconnue - V√©rifiez le format';
        input.dataset.embedUrl = '';
    }
}

// Suppression d'une carte
function supprimerCard(cardId) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette vid√©o ?')) {
        document.getElementById(cardId).remove();
        afficherMessage("Vid√©o supprim√©e.", "success");
    }
}

// G√©n√©ration du JSON final avec fusion intelligente
function genererJSON() {
    // 1. Partir du JSON existant complet (preserve les vid√©os non touch√©es)
    const newJson = JSON.parse(JSON.stringify(jsonData));
    
    // 2. Supprimer les vid√©os qui ont √©t√© originalement charg√©es de leurs emplacements d'origine
    videosOriginalesChargees.forEach(videoDataStr => {
        try {
            const videoOrigine = JSON.parse(videoDataStr);
            const pathParts = videoOrigine.chemin.split(' > ');
            
            if (pathParts.length === 2) {
                const [partie, sousPart] = pathParts;
                if (newJson[partie] && Array.isArray(newJson[partie][sousPart])) {
                    // Supprimer la vid√©o originale de son emplacement d'origine
                    newJson[partie][sousPart] = newJson[partie][sousPart].filter(video => 
                        !(video.titre === videoOrigine.titre && video.url === videoOrigine.url)
                    );
                }
            }
        } catch (error) {
            console.error('Erreur lors de la suppression de la vid√©o originale:', error);
        }
    });
    
    // 3. Ajouter toutes les cartes actuelles (nouvelles + charg√©es √©ventuellement modifi√©es)
    let compteurVideos = 0;
    let erreurs = [];
    
    document.querySelectorAll('.card').forEach(card => {
        const titre = card.querySelector('.titre').value.trim();
        const input = card.querySelector('.iframe');
        const categorieComplete = card.querySelector('.categorie').value;
        
        if (!titre || !input.value.trim() || !categorieComplete) {
            erreurs.push('Une ou plusieurs cartes ont des champs manquants');
            return;
        }
        
        // R√©cup√©rer l'URL embed depuis le dataset ou la calculer
        let embedUrl = input.dataset.embedUrl;
        if (!embedUrl) {
            embedUrl = toEmbedUrl(input.value.trim());
        }
        
        if (!embedUrl) {
            erreurs.push(`URL YouTube invalide pour la vid√©o "${titre}"`);
            return;
        }
        
        try {
            // Navigation vers la cat√©gorie appropri√©e
            const pathParts = categorieComplete.split(' > ');
            let current = newJson;
            
            // Naviguer jusqu'au dernier niveau
            for (let i = 0; i < pathParts.length; i++) {
                const part = pathParts[i];
                if (i === pathParts.length - 1) {
                    // Dernier niveau : doit √™tre un tableau pour les vid√©os
                    if (!current[part]) current[part] = [];
                    if (!Array.isArray(current[part])) {
                        current[part] = [];
                    }
                    current[part].push({ titre, url: embedUrl });
                } else {
                    // Niveau interm√©diaire : doit √™tre un objet
                    if (!current[part]) current[part] = {};
                    current = current[part];
                }
            }
            
            compteurVideos++;
        } catch (error) {
            erreurs.push(`Erreur lors du traitement de la vid√©o "${titre}": ${error.message}`);
        }
    });
    
    const jsonText = JSON.stringify(newJson, null, 2);
    document.getElementById('resultJSON').value = jsonText;
    
    if (erreurs.length > 0) {
        afficherMessage(`Erreurs d√©tect√©es: ${erreurs.join(', ')}`, "error");
        return;
    }
    
    // Compter aussi les vid√©os pr√©serv√©es du JSON original
    let videosPreservees = 0;
    function compterVideosRecursivement(obj) {
        Object.values(obj).forEach(value => {
            if (Array.isArray(value)) {
                videosPreservees += value.length;
            } else if (typeof value === 'object') {
                compterVideosRecursivement(value);
            }
        });
    }
    compterVideosRecursivement(newJson);
    
    if (videosPreservees === 0) {
        afficherMessage("Aucune vid√©o valide √† traiter.", "error");
        return;
    }
    
    // Copie dans le presse-papier
    navigator.clipboard.writeText(jsonText).then(() => {
        const cartesTraitees = compteurVideos;
        const totalVideos = videosPreservees;
        afficherMessage(`JSON g√©n√©r√© avec ${totalVideos} vid√©o(s) total (${cartesTraitees} depuis les cartes) et copi√© dans le presse-papier !`, "success");
    }).catch(err => {
        console.error('Erreur lors de la copie:', err);
        afficherMessage(`JSON g√©n√©r√© avec ${videosPreservees} vid√©o(s). Erreur lors de la copie.`, "error");
    });
}

// Nouvelle fonction pour t√©l√©charger le JSON
function telechargerJSON() {
    const jsonText = document.getElementById('resultJSON').value;
    
    if (!jsonText || jsonText === "Le JSON g√©n√©r√© appara√Ætra ici...") {
        afficherMessage("G√©n√©rez d'abord le JSON avant de le t√©l√©charger.", "error");
        return;
    }
    
    try {
        // Cr√©er un blob avec le contenu JSON
        const blob = new Blob([jsonText], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Cr√©er un lien de t√©l√©chargement temporaire
        const a = document.createElement('a');
        a.href = url;
        a.download = `videos.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Nettoyer l'URL temporaire
        URL.revokeObjectURL(url);
        
        afficherMessage("Fichier JSON t√©l√©charg√© avec succ√®s !", "success");
    } catch (error) {
        console.error('Erreur lors du t√©l√©chargement:', error);
        afficherMessage("Erreur lors du t√©l√©chargement du fichier.", "error");
    }
}

// Fonction pour ouvrir le modal de s√©lection des cat√©gories
function ouvrirModalChargement() {
    if (!isDataLoaded || Object.keys(jsonData).length === 0) {
        afficherMessage("Aucune donn√©e √† charger. Le fichier JSON est vide.", "error");
        return;
    }
    
    const modal = document.getElementById('categoryModal');
    const categoryList = document.getElementById('categoryList');
    
    // Vider la liste pr√©c√©dente
    categoryList.innerHTML = '';
    
    // G√©n√©rer la liste des parties principales
    Object.keys(jsonData).forEach(partie => {
        if (typeof jsonData[partie] === 'object' && !Array.isArray(jsonData[partie])) {
            const div = document.createElement('div');
            div.className = 'category-item';
            div.innerHTML = `
                <input type="checkbox" id="cat_${partie}" value="${partie}">
                <label for="cat_${partie}"><strong>${partie}</strong></label>
            `;
            categoryList.appendChild(div);
            
            // Ajouter les sous-cat√©gories avec indentation
            Object.keys(jsonData[partie]).forEach(sousPart => {
                if (Array.isArray(jsonData[partie][sousPart])) {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'category-item';
                    subDiv.style.paddingLeft = '30px';
                    const fullPath = `${partie} > ${sousPart}`;
                    subDiv.innerHTML = `
                        <input type="checkbox" id="cat_${partie}_${sousPart}" value="${fullPath}">
                        <label for="cat_${partie}_${sousPart}">‚îî‚îÄ ${sousPart}</label>
                    `;
                    categoryList.appendChild(subDiv);
                }
            });
        }
    });
    
    modal.style.display = 'block';
}

// Fonction pour fermer le modal
function fermerModalChargement() {
    document.getElementById('categoryModal').style.display = 'none';
}

// Fonction pour charger les vid√©os s√©lectionn√©es
function chargerVideosSelectionnees() {
    const checkboxes = document.querySelectorAll('#categoryList input[type="checkbox"]:checked');
    
    if (checkboxes.length === 0) {
        afficherMessage("S√©lectionnez au moins une cat√©gorie √† charger.", "error");
        return;
    }
    
    let compteurChargees = 0;
    let compteurDoublons = 0;
    const videosExistantes = getVideosExistantes();
    
    checkboxes.forEach(checkbox => {
        const chemin = checkbox.value;
        const pathParts = chemin.split(' > ');
        
        let videos = [];
        if (pathParts.length === 1) {
            // Partie principale - charger toutes les sous-cat√©gories
            const partie = pathParts[0];
            if (jsonData[partie]) {
                Object.keys(jsonData[partie]).forEach(sousPart => {
                    if (Array.isArray(jsonData[partie][sousPart])) {
                        jsonData[partie][sousPart].forEach(video => {
                            videos.push({
                                ...video,
                                categorie: `${partie} > ${sousPart}`,
                                cheminOriginal: `${partie} > ${sousPart}` // Tracker le chemin d'origine
                            });
                        });
                    }
                });
            }
        } else {
            // Sous-cat√©gorie sp√©cifique
            const [partie, sousPart] = pathParts;
            if (jsonData[partie] && jsonData[partie][sousPart] && Array.isArray(jsonData[partie][sousPart])) {
                videos = jsonData[partie][sousPart].map(video => ({
                    ...video,
                    categorie: chemin,
                    cheminOriginal: chemin // Tracker le chemin d'origine
                }));
            }
        }
        
        // Cr√©er les cartes pour chaque vid√©o (en √©vitant les doublons)
        videos.forEach(video => {
            const cleVideo = `${video.titre}|${video.url}`;
            if (!videosExistantes.has(cleVideo)) {
                creerCarteDepuisVideo(video, true);
                compteurChargees++;
                videosExistantes.add(cleVideo);
                
                // Ajouter au tracker des vid√©os originales avec leur chemin
                videosOriginalesChargees.add(JSON.stringify({
                    titre: video.titre,
                    url: video.url,
                    chemin: video.cheminOriginal
                }));
            } else {
                compteurDoublons++;
            }
        });
    });
    
    // Fermer le modal
    fermerModalChargement();
    
    // Afficher le r√©sultat
    let message = `${compteurChargees} vid√©o(s) charg√©e(s) avec succ√®s !`;
    if (compteurDoublons > 0) {
        message += ` (${compteurDoublons} doublon(s) ignor√©(s))`;
    }
    afficherMessage(message, "success");
}

// Fonction utilitaire pour r√©cup√©rer les vid√©os d√©j√† pr√©sentes
function getVideosExistantes() {
    const videosExistantes = new Set();
    document.querySelectorAll('.card').forEach(card => {
        const titre = card.querySelector('.titre').value.trim();
        const input = card.querySelector('.iframe');
        let url = input.dataset.embedUrl || '';
        if (!url && input.value.trim()) {
            url = toEmbedUrl(input.value.trim()) || input.value.trim();
        }
        if (titre && url) {
            videosExistantes.add(`${titre}|${url}`);
        }
    });
    return videosExistantes;
}

// Fonction pour cr√©er une carte √† partir d'une vid√©o du JSON
function creerCarteDepuisVideo(video, estChargee = false) {
    const container = document.getElementById('cardsContainer');
    const categories = genererOptionsCategories();
    
    if (categories.length === 0) {
        afficherMessage("Aucune cat√©gorie disponible. Cr√©ez d'abord une branche.", "error");
        return;
    }
    
    const cardId = 'card_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    const div = document.createElement('div');
    div.className = estChargee ? 'card loaded' : 'card';
    div.id = cardId;
    
    // Ajouter un attribut data pour tracker l'origine si c'est une carte charg√©e
    if (estChargee && video.cheminOriginal) {
        div.setAttribute('data-origine', JSON.stringify({
            titre: video.titre,
            url: video.url,
            chemin: video.cheminOriginal
        }));
    }
    
    div.innerHTML = `
        <div class="card-header">
            <div class="card-title">${video.titre}</div>
            <button class="supprimer" onclick="supprimerCard('${cardId}')">üóëÔ∏è Supprimer</button>
        </div>
        <div class="card-form">
            <input type="text" placeholder="Titre de la vid√©o" class="titre" value="${video.titre}" onchange="updateCardTitle('${cardId}')">
            <div class="form-row">
                <input type="text" placeholder="Collez n'importe quel lien YouTube ici" class="iframe" value="${video.url}" oninput="updatePreview('${cardId}')">
                <select class="categorie">
                    ${categories.map(cat => `<option value="${cat}" ${cat === video.categorie ? 'selected' : ''}>${cat}</option>`).join('')}
                </select>
            </div>
            <div class="preview">
                <iframe src="${video.url}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
            </div>
        </div>
    `;
    
    container.appendChild(div);
    
    // Stocker l'URL embed dans le dataset
    const input = div.querySelector('.iframe');
    input.dataset.embedUrl = video.url;
    
    return cardId;
}

// Fermer le modal en cliquant √† l'ext√©rieur
window.onclick = function(event) {
    const modal = document.getElementById('categoryModal');
    if (event.target === modal) {
        fermerModalChargement();
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('ajouterBtn').addEventListener('click', ajouterCard);
    chargerDonnees();
});
</script>
</body>
</html>
