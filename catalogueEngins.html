<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Catalogue des engins ferroviaires</title>
    <link rel="stylesheet" href="outils.css">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png">
    <style>
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #search,
        #sort,
        #filter {
            padding: 6px 10px;
            font-size: 0.95rem;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        main {
            padding: 1rem 2rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1rem;
        }

        .card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            cursor: pointer;
            position: relative;
            transition:
                transform 0.25s ease,
                box-shadow 0.25s ease,
                grid-column 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .card img {
            width: 100%;
            height: 100px;
            object-fit: contain;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .card h3 {
            margin: 0.5rem 0;
            font-size: 1rem;
            color: #1e3a8a;
        }

        .card p {
            margin: 0.2rem 0;
            font-size: 0.9rem;
            color: #444;
        }


        /* === Expansion plus douce === */
        .card.expanded {
            grid-column: span 2;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            transition: all 0.35s ease;
        }

        .card-details {
            margin-top: 0.5rem;
            border-top: 1px solid #ddd;
            padding: 0.8rem 1rem;
            text-align: left;
            font-size: 0.9rem;
            color: #333;
            background: #f9fafb;
            border-radius: 0 0 10px 10px;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.35s ease;
        }

        /* apparition fluide du contenu */
        .card.expanded .card-details {
            opacity: 1;
            max-height: 500px;
            /* hauteur max arbitraire, ajustable */
        }

        .close-btn {
            position: absolute;
            top: 6px;
            right: 8px;
            background: #d1d5db;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.15s;
        }

        .close-btn:hover {
            background: #b9bec6;
            transform: scale(1.1);
        }


        .card.expanded .close-btn {
            display: block;
        }

        /* === Lightbox === */
        .image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s ease, visibility 0.25s ease;
        }

        .image-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .image-overlay img {
            max-width: 80%;
            max-height: 90%;
            background: white;
            padding: 20px;
            /* ‚úÖ fond blanc autour de l‚Äôimage */
            border-radius: 12px;
            box-shadow: 0 4px 35px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
            transform: scale(1.2);
            /* ‚úÖ l√©ger zoom */
            transition: transform 0.25s ease;
        }

        .image-overlay img:hover {
            transform: scale(1.3);
        }

        .image-overlay .close-btn {
            position: absolute;
            top: 25px;
            right: 35px;
            width: 34px;
            height: 34px;
            font-size: 18px;
            background: #e5e7eb;
            color: #111;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.15s;
            cursor: pointer;
        }

        .image-overlay .close-btn:hover {
            background: #cbd5e1;
            transform: scale(1.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* === Selects bleus (coh√©rent avec ton style global) === */
        #filter,
        #sort {
            background: #003b73;
            color: #fff;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            cursor: pointer;
        }

        #sort,
        #filter {
            background: #003b73;
            color: #fff;
        }

        .submenu {
            background: #003b73;
            /* fond clair */
            color: #fffefe;
            /* texte sombre */
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            padding: 6px 0;
        }

        .submenu button {
            color: #ffffff;
            /* texte lisible */
            background: none;
        }

        .submenu button:hover {
            background: #257cff;
        }


        /* === Champ recherche avec bouton effacer === */
        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        #search {
            padding-right: 30px;
            /* espace pour la croix */
        }

        /* === Bouton "effacer" dans la barre de recherche === */
        #clear-search {
            all: unset;
            /* ‚úÖ annule tous les styles globaux (box-shadow, padding, etc.) */
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
        }

        #clear-search:hover {
            color: #0070d1;
            /* juste changement de couleur */
            background: none;
            /* aucun fond */
            box-shadow: none;
            /* supprime toute ombre h√©rit√©e */
        }

        .submenu button {
            display: block;
            width: 90%;
            background: none;
            border: none;
            text-align: left;
            padding: 6px 12px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .submenu button:hover {
            background: #257cff;
        }
    </style>
</head>

<body>
    <header>
        <h1>
            <a href="./index.html"><button>üè†</button></a>
            Catalogue des engins ferroviaires
        </h1>

        <div class="header-right">
            <div class="search-wrapper">
                <input type="text" id="search" placeholder="Rechercher...">
                <button id="clear-search" title="Effacer">‚úï</button>
            </div>

            <select id="filter">
                <option value="all">Tous</option>
                <option value="train">Trains</option>
                <option value="wagon">Wagons</option>
            </select>

            <select id="sort">
                <option value="">Trier par...</option>
                <option value="pays">Pays</option>
                <option value="typeEngin">Type d‚Äôengin</option>
                <option value="moteurs">Type d‚Äôalimentation</option>
                <option value="vitesseMax">Vitesse max</option>
                <option value="nom">Nom</option>
            </select>
            <!-- ‚úÖ Le sous-menu doit √™tre en dehors -->
            <div id="submenu" class="submenu" style="
                display:none;
                position:absolute;
                top:50px;
                right:2rem;
                background:#003b73;
                border:1px solid #ccc;
                border-radius:6px;
                box-shadow:0 2px 6px rgba(0,0,0,0.2);
                z-index:100;
                padding:6px 0;">
            </div>
        </div>

    </header>

    <main>
        <div class="grid" id="grid"></div>
    </main>

    <script>
        async function chargerEngins() {
            const res = await fetch("./src/engins.json");
            const data = await res.json();
            const engins = [
                ...data.trains.map(t => ({ ...t, classe: "train" })),  // NE TOUCHE PAS t.type
                ...data.wagons.map(w => ({ ...w, classe: "wagon" }))
            ];


            const grid = document.getElementById("grid");
            const search = document.getElementById("search");
            const sort = document.getElementById("sort");
            const filter = document.getElementById("filter");

            // üîç R√©cup√®re le nom de train dans l‚ÄôURL (ex: ?train=Regiolis%20fluoGrandEst%205C)
            const params = new URLSearchParams(window.location.search);
            const trainNom = params.get("train");


            function afficher(filtre = "", tri = "", typeFiltre = "all", sousFiltre = null) {
                function getSpeedColor(vitesse) {
                    if (!vitesse) return "white";
                    const min = 60, max = 320; // √©chelle
                    const ratio = Math.min(1, Math.max(0, (vitesse - min) / (max - min)));
                    const r = Math.round(255 * ratio);
                    const g = Math.round(200 * (1 - ratio));
                    const b = Math.round(255 * (1 - ratio));
                    return `rgba(${r}, ${g}, ${b}, 0.2)`; // couleur douce
                }
                function getAlimGradient(moteurs) {
                    const colors = {
                        "25kV": "rgb(255, 120, 120, 0.5)",
                        "15kV": "rgb(130, 220, 130, 0.5)",
                        "1.5kV": "rgb(0, 152, 203, 0.5)",
                        "3kV": "rgb(0, 0, 255, 0.5)",
                        "diesel": "rgb(210, 210, 210, 0.5)"
                    };

                    const valid = Object.keys(colors).filter(k =>
                        moteurs.some(m => m.includes(k))
                    );

                    if (valid.length === 0) return "rgb(0,0,0)";

                    if (valid.length === 1) return colors[valid[0]];

                    // üëâ cr√©er un d√©grad√© selon le nombre d'alims
                    const stops = valid.map((k, i) => `${colors[k]} ${(i / (valid.length - 1)) * 100}%`);
                    return `linear-gradient(90deg, ${stops.join(", ")})`;
                }


                grid.innerHTML = "";

                let resultats = engins.filter(e =>
                    e.nom.toLowerCase().includes(filtre.toLowerCase())
                );

                if (typeFiltre !== "all") {
                    resultats = resultats.filter(e => e.classe === typeFiltre);
                }

                if (tri) {
                    resultats.sort((a, b) => {
                        switch (tri) {
                            case "vitesseMax":
                                return (b.vitesseMax || 0) - (a.vitesseMax || 0);
                            case "nom":
                                return a.nom.localeCompare(b.nom);
                            case "pays":
                                return (a.pays || "").localeCompare(b.pays || "");
                            case "typeEngin":
                                const ordre = { "Voyageur": 1, "Poly": 2, "Fret": 3 };
                                return (ordre[a.type] || 99) - (ordre[b.type] || 99);
                            case "moteurs":
                                return (a.moteurs?.join(",") || "").localeCompare(b.moteurs?.join(",") || "");
                            default:
                                return 0;
                        }
                    });
                }
                // --- Sous-filtre contextuel selon le tri courant ---
                if (sousFiltre) {
                    if (tri === "pays") {
                        // FR / DE / CH
                        resultats = resultats.filter(e => (e.pays || "") === sousFiltre);
                    } else if (tri === "typeEngin") {
                        // Voyageur / Fret / Poly
                        resultats = resultats.filter(e => (e.type || "") === sousFiltre);
                    } else if (tri === "moteurs") {
                        // "25kV CA","3kV CC", "15kV CA", "1.5kV CC", "diesel"
                        const needle = sousFiltre.toLowerCase();
                        resultats = resultats.filter(e => (e.moteurs || []).some(m => m.toLowerCase().includes(needle)));
                    }
                }



                resultats.forEach(e => {
                    const imageName = e.nom.replaceAll(" ", "_") + ".png";
                    const imagePath = `./assets/trains/${imageName}`;

                    const div = document.createElement("div");
                    div.className = "card";
                    if (tri === "vitesseMax" && e.vitesseMax) {
                        div.style.background = getSpeedColor(e.vitesseMax);
                    }
                    if (tri === "pays" && e.pays) {
                        const colors = {
                            FR: "rgb(210, 230, 255)", // bleu clair
                            DE: "rgb(255, 245, 180)", // jaune p√¢le
                            CH: "rgb(255, 180, 180)", // rouge clair
                            IT: "rgb(100, 200, 100)", // vert moyen
                            BE: "rgb(240, 200, 40)",  // jaune-orang√© chaud
                            NL: "rgb(251, 140, 5)", // orang
                            LU: "rgb(130, 160, 255)"  // bleu plus soutenu
                        };
                        div.style.background = colors[e.pays] || "#f9fafb";
                    }
                    // === Couleur de fond selon le type d'engin ===
                    if (tri === "typeEngin" && e.type) {
                        const colors = {
                            "Voyageur": "rgba(173, 216, 230, 0.3)", // bleu clair
                            "Fret": "rgba(205, 133, 63, 0.3)",      // brun clair
                            "Poly": "linear-gradient(90deg, rgba(173,216,230,0.3), rgba(205,133,63,0.3))"
                        };
                        div.style.background = colors[e.type] || "#f9fafb";
                    }

                    if (tri === "moteurs" && e.moteurs) {
                        div.style.background = getAlimGradient(e.moteurs);
                    }



                    div.innerHTML = `
                    <button class="close-btn">‚úï</button>
                    <img src="${imagePath}" alt="${e.nom}">
                    <h3>${e.nom}</h3>
                    ${e.vitesseMax ? `<p><b>${e.vitesseMax} km/h</b></p>` : ""}
                    ${e.moteurs ? `<p>${e.moteurs.join(", ")}</p>` : ""}
                    
                    ${tri === "typeEngin" && e.type ? `
                    <p style="color:${e.type === 'Fret' ? '#8B4513' : e.type === 'Poly' ? '#4B0082' : '#1e3a8a'}; font-weight:600;">
                        ${e.type === 'Fret' ? 'üì¶ FRET' : e.type === 'Poly' ? 'üî∑ POLY' : e.type === 'Voyageur' ? 'üöÜ VOYAGEUR' : ''}
                    </p>` : ""}`;

                    const details = document.createElement("div");
                    details.className = "card-details";
                    details.innerHTML = `
                        ${e.classe ? `<p><b>Cat√©gorie :</b> ${e.classe === "train" ? "Train" : "Wagon"}</p>` : ""}
                        ${e.type ? `<p><b>Type d‚Äôengin :</b> ${e.type}</p>` : ""}
                        ${e.capacite ? (() => {
                            const total = (e.capacite.premiere || 0) + (e.capacite.seconde || 0);
                            const detail = Object.entries(e.capacite)
                                .map(([k, v]) => `${k}: ${v}`)
                                .join(", ");
                            return `<p><b>Capacit√© :</b> ${detail} ‚ñ∂ (total : <b>${total}</b>)</p>`;
                        })() : ""}
                        ${e.tonnage ? `<p><b>Tonnage :</b> ${e.tonnage} t</p>` : ""}
                        ${e.pays ? `<p><b>Pays :</b> ${e.pays}</p>` : ""}
                        ${e.dateSortie ? `<p><b>Sortie :</b> ${e.dateSortie}</p>` : ""}
                        ${e.poids ? `<p><b>Poids :</b> ${e.poids} t</p>` : ""}
                        ${e.longueur ? `<p><b>Longueur :</b> ${e.longueur} m</p>` : ""}
                        ${e.remarque ? `<p><i>${e.remarque}</i></p>` : ""}
                    `;
                    details.style.display = "none";

                    div.appendChild(details);

                    div.addEventListener("click", (ev) => {
                        if (div.classList.contains("expanded")) return;
                        document.querySelectorAll(".card.expanded").forEach(c => {
                            c.classList.remove("expanded");
                            c.querySelector(".card-details").style.display = "none";
                        });
                        div.classList.add("expanded");
                        details.style.display = "block";
                        ev.stopPropagation();
                    });

                    div.querySelector(".close-btn").addEventListener("click", (ev) => {
                        div.classList.remove("expanded");
                        details.style.display = "none";
                        ev.stopPropagation();
                    });

                    grid.appendChild(div);
                });
                // ‚úÖ Si aucun r√©sultat
                if (resultats.length === 0) {
                    grid.innerHTML = `
                    <div style="
                    grid-column: 1 / -1;
                    text-align: center;
                    font-size: 1.1rem;
                    color: #555;
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 1rem;
                    border: 1px solid #ddd;
                    ">
                    üîé Aucun engin trouv√© pour "<b>${filtre || "votre recherche"}</b>"
                    </div>`;
                }
            }
            // === SOUS-MENU ===
            const submenu = document.getElementById("submenu");
            const optionsSubmenu = {
                "pays": ["FR", "DE", "CH", "IT", "BE", "NL", "LU"],
                "typeEngin": ["Voyageur", "Fret", "Poly"],
                "moteurs": ["25kV CA", "15kV CA", "1.5kV CC", "3kV CC", "diesel"]
            };

            let currentSubmenuFilter = null;

            let lastTri = ""; // ‚úÖ Variable pour m√©moriser le dernier tri

            // ‚úÖ Utiliser "click" sur le select pour d√©tecter les reclics
            sort.addEventListener("click", e => {
                const tri = sort.value;

                // Si on clique sur le select ET qu'il a d√©j√† un sous-menu disponible
                if (tri === lastTri && optionsSubmenu[tri] && submenu.style.display === "none") {
                    submenu.style.display = "block";
                    const rect = sort.getBoundingClientRect();
                    submenu.style.left = rect.left + "px";
                    submenu.style.top = rect.bottom + 6 + "px";
                    submenu.style.width = rect.width + "px";
                }
            });

            sort.addEventListener("change", e => {
                const tri = e.target.value;

                // Si tri par alimentation ‚Üí on force "trains"
                if (tri === "moteurs") {
                    filter.value = "train";
                }

                // On r√©initialise le sous-filtre
                currentSubmenuFilter = null;

                // Afficher le sous-menu SI il existe pour ce tri
                if (optionsSubmenu[tri]) {
                    submenu.innerHTML = optionsSubmenu[tri]
                        .map(opt => `<button data-value="${opt}">${opt}</button>`)
                        .join("");
                    const rect = e.target.getBoundingClientRect();
                    submenu.style.left = rect.left + "px";
                    submenu.style.top = rect.bottom + 6 + "px";
                    submenu.style.width = rect.width + "px";
                    submenu.style.display = "block";
                } else {
                    submenu.style.display = "none";
                }

                lastTri = tri; // ‚úÖ M√©moriser le tri actuel

                // Afficher les r√©sultats m√™me sans sous-menu
                afficher(search.value, tri, filter.value, currentSubmenuFilter);
            });


            submenu.addEventListener("click", e => {
                const tri = sort.value;
                const val = e.target.getAttribute("data-value");
                if (!val) return;
                currentSubmenuFilter = val;
                submenu.style.display = "none";
                afficher(search.value, tri, filter.value, val);
            });

            document.addEventListener("click", e => {
                if (!submenu.contains(e.target) && e.target.id !== "sort") {
                    submenu.style.display = "none";
                }
            });

            afficher("", sort.value, filter.value, currentSubmenuFilter);

            // Si un param√®tre ?train= est pr√©sent ‚Üí pr√©remplir et afficher
            if (trainNom) {
                search.value = trainNom;

                // attendre que le DOM des cartes soit rendu
                setTimeout(() => {
                    afficher(trainNom, sort.value, filter.value, currentSubmenuFilter);

                    // Cherche la carte exacte
                    const match = Array.from(document.querySelectorAll(".card")).find(c =>
                        c.querySelector("h3")?.textContent.toLowerCase() === trainNom.toLowerCase()
                    );

                    // Si trouv√©e, on l'agrandit automatiquement
                    if (match) {
                        const details = match.querySelector(".card-details");
                        match.classList.add("expanded");
                        if (details) details.style.display = "block";
                        match.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                }, 100);
            }


            search.addEventListener("input", () => afficher(search.value, sort.value, filter.value, currentSubmenuFilter));


            filter.addEventListener("change", () => afficher(search.value, sort.value, filter.value, currentSubmenuFilter));

            // === Bouton effacer la recherche ===
            const clearBtn = document.getElementById("clear-search");
            if (clearBtn) {
                clearBtn.addEventListener("click", () => {
                    document.getElementById("search").value = "";
                    currentSubmenuFilter = null;
                    afficher("", sort.value, filter.value, currentSubmenuFilter);

                });
            }
        }

        chargerEngins();

    </script>

    <div class="image-overlay" id="imageOverlay">
        <button class="close-btn" id="closeOverlay">‚úï</button>
        <img id="overlayImage" src="" alt="Agrandissement">
    </div>

    <script>
        // === LIGHTBOX IMAGE ===
        const overlay = document.getElementById("imageOverlay");
        const overlayImg = document.getElementById("overlayImage");
        const closeOverlay = document.getElementById("closeOverlay");

        document.addEventListener("click", (ev) => {
            const target = ev.target;
            if (target.tagName === "IMG" && target.closest(".card")) {
                overlayImg.src = target.src;
                overlay.classList.add("active");
            }
        });

        closeOverlay.addEventListener("click", () => {
            overlay.classList.remove("active");
        });

        overlay.addEventListener("click", (ev) => {
            if (ev.target === overlay) {
                overlay.classList.remove("active");
            }
        });
    </script>
</body>

</html>