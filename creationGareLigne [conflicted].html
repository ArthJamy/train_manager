<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>√âditeur ferroviaire - Gares & Lignes</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #eef3fa;
    margin: 0;
  }
  header {
    background: #2b6df2;
    color: white;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header h1 { font-size: 1.2rem; margin: 0; }
  header button {
    background: white; color: #2b6df2; border: none; border-radius: 5px;
    padding: 6px 12px; margin-left: 6px; cursor: pointer; font-weight: bold;
  }
  header button:hover { background: #eef3fa; }
  main { display: flex; gap: 2rem; padding: 1rem 2rem; }
  h2 { text-align: center; margin-bottom: 0.5rem; }
  .colonne {
    flex: 1; background: #fff; border-radius: 10px; padding: 1rem;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  .card {
    border: 1px solid #ccc; border-radius: 8px; padding: 1rem;
    margin-bottom: 1rem; background: #fafafa;
  }
  label { font-weight: 600; display:block; margin-top: 6px; }
  input, select {
    padding: 6px; margin: 4px 0; width: 100%;
    border-radius: 4px; border: 1px solid #aaa;
  }
  input[readonly] { background:#f2f2f2; }
  button {
    background: #2b6df2; color: white; border: none; border-radius: 5px;
    padding: 6px 10px; margin-top: 6px; cursor: pointer;
  }
  button:hover { background: #1f4eb8; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .list {
    font-family: monospace; background: #f8f8f8; border: 1px solid #ccc;
    padding: 6px; border-radius: 5px; max-height: 240px; overflow-y: auto; margin-top: 6px;
  }
  .small { font-size: 12px; color:#666; }
</style>
</head>
<body>

<header>
  <h1>üöâ √âditeur de gares & lignes ferroviaires</h1>
  <div>
    <button onclick="telechargerGares()">üíæ T√©l√©charger gares.js</button>
    <button onclick="telechargerLignes()">üíæ T√©l√©charger voies.js</button>
  </div>
</header>

<main>
  <!-- GARes -->
  <div class="colonne" id="colGares">
    <h2>Gares</h2>
    <div id="garesContainer"></div>
    <button onclick="ajouterCarteGare()">+ Ajouter une gare</button>
    <div class="list" id="listeGares"></div>
    <div class="small">Astuce : colle un lien Google Maps (formats vari√©s accept√©s). Le nom encod√© sera d√©cod√© automatiquement.</div>
  </div>

  <!-- LIGNES -->
  <div class="colonne" id="colLignes">
    <h2>Lignes</h2>
    <div id="lignesContainer"></div>
    <button onclick="ajouterCarteLigne()">+ Ajouter une ligne</button>
    <div class="list" id="listeLignes"></div>
  </div>
</main>

<script>

/* ================== !!!!!!!!!!!  PARAMS CARTE !!!!!!!!!!!   ================== */
const origine = { lat: 47.7627516, lon: 7.3184965 }; // Mulhouse = (0,0)
const echelle = 2000; // nombre de pixels par degr√© (~ Alsace)
const FLUX_PAR_TAILLE = { petite:1500, moyenne:8000, grande:15000, vaste:40000 };
/* ================== !!!!!!!!!!!  PARAMS CARTE !!!!!!!!!!!   ================== */




/* ================== ETATS ================== */
let garesExistantes = [];   // normalis√©es: {nom,x,y,type,fluxPassager}
let lignesExistantes = [];  // tel le fichier
let nouvellesGares = [];
let nouvellesLignes = [];

/* ================== OUTILS ================== */
function latLonToXY(lat, lon) {
  const x = (lon - origine.lon) * echelle;
  const y = (origine.lat - lat) * echelle;
  return {x,y};
}
function normaliserGare(g) {
  const type = g.type ?? g.taille ?? 'petite';
  const flux = (g.fluxPassager != null) ? g.fluxPassager : (FLUX_PAR_TAILLE[type] ?? FLUX_PAR_TAILLE.petite);
  return { nom: g.nom, x: Number(g.x), y: Number(g.y), type, fluxPassager: Number(flux) };
}
function extraireArrayDepuisTexte(texte, varName) {
  // 1) export const villes = [ ... ]
  let re = new RegExp(`export\\s+(?:const|let|var)\\s+${varName}\\s*=\\s*(\\[[\\s\\S]*?\\])`, 'm');
  let m = re.exec(texte);
  if (m) { try { return eval(m[1]); } catch(e) {} }
  // 2) export default [ ... ]
  re = /export\s+default\s+(\[[\s\S]*?\])/m;
  m = re.exec(texte);
  if (m) { try { return eval(m[1]); } catch(e) {} }
  // 3) premier tableau trouv√©
  m = /\[[\s\S]*\]/m.exec(texte);
  if (m) { try { return eval(m[0]); } catch(e) {} }
  return [];
}


/* ================== CHARGEMENT EXISTANT ================== */
async function chargerDonnees() {
  try {
    // üëâ Chemins d√©sormais fixes et corrects
    const g = await fetch("./src/gares.js", {cache:"no-store"});
    const v = await fetch("./src/voies.js", {cache:"no-store"});

    if (!g.ok || !v.ok) throw new Error("Fichiers introuvables");

    const texteG = await g.text();
    const texteV = await v.text();

    // Extraction propre des tableaux
    const villes = extraireArrayDepuisTexte(texteG, "villes");
    const lignes = extraireArrayDepuisTexte(texteV, "lignes");

    // Normalisation et affichage
    garesExistantes = villes.map(normaliserGare);
    lignesExistantes = lignes;

    majListeGares();
    majListeLignes();
    majSelectsGares();
    console.log("‚úÖ Donn√©es charg√©es depuis ./src/");
  } catch (e) {
    console.error("‚ö†Ô∏è Impossible de charger les fichiers :", e);
  }
}
chargerDonnees();


/* ================== GARes ================== */
function ajouterCarteGare() {
  const container = document.getElementById("garesContainer");
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `
    <label>Lien Google Maps</label>
    <input type="text" placeholder="Coller ici (place, search, ?q=..., etc.)" onblur="extraireDepuisLien(this)">
    <div class="row">
      <div>
        <label>Nom</label>
        <input type="text" class="nom" placeholder="Nom de la gare">
      </div>
      <div>
        <label>Taille</label>
        <select class="type" onchange="majFluxPourCarte(this)">
          <option value="petite" selected>petite</option>
          <option value="moyenne">moyenne</option>
          <option value="grande">grande</option>
          <option value="vaste">vaste</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Latitude</label>
        <input type="number" class="lat" step="0.000001" placeholder="ex : 47.6270725">
      </div>
      <div>
        <label>Longitude</label>
        <input type="number" class="lon" step="0.000001" placeholder="ex : 7.2390608">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Flux passager (auto)</label>
        <input type="number" class="flux" value="${FLUX_PAR_TAILLE.petite}" readonly>
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button onclick="calculerXYApercu(this)">üìê Aper√ßu (x,y)</button>
        <button onclick="validerGare(this)">‚úÖ Ajouter</button>
      </div>
    </div>
  `;
  container.appendChild(div);
}
function majFluxPourCarte(sel) {
  const card = sel.closest(".card");
  const taille = sel.value;
  const fluxInput = card.querySelector(".flux");
  fluxInput.value = FLUX_PAR_TAILLE[taille] ?? FLUX_PAR_TAILLE.petite;
}
function setLatLon(card, lat, lon) {
  if (lat != null) card.querySelector(".lat").value = parseFloat(lat);
  if (lon != null) card.querySelector(".lon").value = parseFloat(lon);
}
function extraireDepuisLien(input) {
  const s = input.value.trim();
  const card = input.closest(".card");

  // Nom (plusieurs cas : /place/XXX, /search/XXX, ?q=XXX, etc.)
  let nom = null, m;
  m = s.match(/place\/([^/@?]+)/); if (m) nom = m[1];
  if (!nom) { m = s.match(/maps\/search\/([^/@?]+)/); if (m) nom = m[1]; }
  if (!nom) { m = s.match(/[?&]q=([^&]+)/); if (m) nom = m[1]; }
  if (nom) {
    nom = decodeURIComponent(nom).replace(/\+/g,' ');
    card.querySelector(".nom").value = nom;
  }

  // Coordonn√©es : @lat,lon ... | !3dLAT!4dLON | FALLBACK : 1er couple de nombres
  m = s.match(/@(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/);
  if (m) setLatLon(card, m[1], m[2]);
  else {
    m = s.match(/!3d(-?\d+(?:\.\d+)?)!4d(-?\d+(?:\.\d+)?)/);
    if (m) setLatLon(card, m[1], m[2]);
    else {
      // Dernier recours : premier couple "nombre, nombre" dans la cha√Æne
      const n = s.match(/(-?\d+(?:\.\d+)?)[ ,]+(-?\d+(?:\.\d+)?)/);
      if (n) setLatLon(card, n[1], n[2]);
    }
  }
}
function calculerXYApercu(btn){
  const card = btn.closest(".card");
  const lat = parseFloat(card.querySelector(".lat").value);
  const lon = parseFloat(card.querySelector(".lon").value);
  if (isNaN(lat)||isNaN(lon)) { alert("Lat/Lon manquants"); return; }
  const {x,y} = latLonToXY(lat,lon);
  alert(`x: ${x.toFixed(1)}  |  y: ${y.toFixed(1)}`);
}
function validerGare(btn){
  const card = btn.closest(".card");
  const nom = card.querySelector(".nom").value.trim();
  const lat = parseFloat(card.querySelector(".lat").value);
  const lon = parseFloat(card.querySelector(".lon").value);
  const type = card.querySelector(".type").value;
  const flux = parseInt(card.querySelector(".flux").value, 10);

  if(!nom || isNaN(lat) || isNaN(lon)){ alert("Champs incomplets"); return; }
  const {x,y} = latLonToXY(lat,lon);
  nouvellesGares.push({nom, x, y, type, fluxPassager: flux});
  majListeGares();
  majSelectsGares();
  card.remove();
}
function majListeGares(){
  const toutes = [...garesExistantes, ...nouvellesGares];
  const out = toutes.map(g => `${g.nom} ‚Üí x:${g.x.toFixed(1)}, y:${g.y.toFixed(1)}, ${g.type}, flux:${g.fluxPassager}`).join("\n");
  document.getElementById("listeGares").textContent = out || "(aucune gare)";
}
function majSelectsGares(){
  const noms = [...garesExistantes, ...nouvellesGares].map(g=>g.nom);
  document.querySelectorAll(".selectGare").forEach(sel=>{
    const current = sel.value;
    sel.innerHTML = "";
    noms.forEach(n=>{
      const opt = document.createElement("option");
      opt.textContent = n; opt.value = n;
      sel.appendChild(opt);
    });
    if(current && noms.includes(current)) sel.value = current;
  });
}

/* ================== LIGNES ================== */
function ajouterCarteLigne(){
  const container = document.getElementById("lignesContainer");
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `
    <label>Gare A</label><select class="selectGare gareA"></select>
    <label>Gare B</label><select class="selectGare gareB"></select>
    <div class="row">
      <div>
        <label>Longueur (km)</label>
        <input type="number" class="longueur" step="0.1" placeholder="auto via üìè Calculer">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button onclick="calculerDistanceLigne(this)">üìè Calculer</button>
      </div>
    </div>
    <label>Type</label>
    <select class="type">
      <option value="classique" selected>classique</option>
      <option value="LGV">LGV</option>
    </select>
    <label>Vitesse max (km/h)</label>
    <input type="number" class="vitesse" value="140">
    <label>√âlectrification</label>
    <select class="elec">
      <option value="diesel" selected>diesel</option>
      <option value="25kV CA">25kV CA</option>
      <option value="15kV CA">15kV CA</option>
      <option value="1.5kV CC">1.5kV CC</option>
    </select>
    <label>Signalisation</label>
    <select class="sign">
      <option value="KVB" selected>KVB</option>
      <option value="ETCS">ETCS</option>
      <option value="PZB">PZB</option>
      <option value="LZB">LZB</option>
    </select>
    <button onclick="validerLigne(this)">‚úÖ Ajouter</button>
  `;
  container.appendChild(div);
  majSelectsGares();

  // Calcul auto quand on change A/B (facultatif, laisse la main pour modifier)
  const a = div.querySelector(".gareA");
  const b = div.querySelector(".gareB");
  [a,b].forEach(sel => sel.addEventListener("change", ()=> calculerDistanceLigne(div.querySelector("button[onclick^='calculerDistanceLigne']"))));
}
function getXYByName(nom){
  const g = [...garesExistantes, ...nouvellesGares].find(x=>x.nom===nom);
  return g ? {x:g.x, y:g.y} : null;
}
function calculerDistanceLigne(triggerBtn){
  const card = triggerBtn.closest(".card");
  const gareA = card.querySelector(".gareA").value;
  const gareB = card.querySelector(".gareB").value;
  const a = getXYByName(gareA);
  const b = getXYByName(gareB);
  if(!a||!b){ alert("Coordonn√©es manquantes"); return; }
  // distance approximative √† partir des x/y (1¬∞ ‚âà 111 km)
  const dx = a.x - b.x, dy = a.y - b.y;
  const distKm = Math.sqrt(dx*dx + dy*dy) / echelle * 111;
  card.querySelector(".longueur").value = distKm.toFixed(1);
}
function validerLigne(btn){
  const card = btn.closest(".card");
  const gareA = card.querySelector(".gareA").value;
  const gareB = card.querySelector(".gareB").value;
  const longueur = parseFloat(card.querySelector(".longueur").value)||0;
  const type = card.querySelector(".type").value;
  const vitesse = parseInt(card.querySelector(".vitesse").value)||140;
  const elec = card.querySelector(".elec").value;
  const sign = card.querySelector(".sign").value;
  nouvellesLignes.push({gareA,gareB,longueur,type,vitesse_max:vitesse,electrification:elec,signalisation:sign});
  majListeLignes();
  card.remove();
}
function majListeLignes(){
  const toutes = [...lignesExistantes, ...nouvellesLignes];
  const out = toutes.map(l => `${l.gareA} ‚Üî ${l.gareB} (${l.longueur} km) [${l.type}, ${l.vitesse_max} km/h, ${l.electrification}, ${l.signalisation}]`).join("\n");
  document.getElementById("listeLignes").textContent = out || "(aucune ligne)";
}

/* ================== EXPORT ================== */
function telechargerGares(){
  const toutes = [...garesExistantes, ...nouvellesGares];
  const contenu =
`export const villes = [
${toutes.map(g=>`  { nom: "${g.nom}", x: ${g.x.toFixed(1)}, y: ${g.y.toFixed(1)}, type: "${g.type}", fluxPassager: ${g.fluxPassager} }`).join(",\n")}
];`;
  telechargerFichier("gares.js", contenu);
}
function telechargerLignes(){
  const toutes = [...lignesExistantes, ...nouvellesLignes];
  const contenu =
`export const lignes = [
${toutes.map(l=>`  { gareA: "${l.gareA}", gareB: "${l.gareB}", longueur: ${l.longueur}, type: "${l.type}", vitesse_max: ${l.vitesse_max}, electrification: "${l.electrification}", signalisation: "${l.signalisation}" }`).join(",\n")}
];`;
  telechargerFichier("voies.js", contenu);
}
function telechargerFichier(nom, contenu){
  const blob = new Blob([contenu], {type:"text/javascript"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = nom;
  a.click();
}
</script>
</body>
</html>
